<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>WorldMarketReviewer</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial;
  background:#0f172a;
  color:white;
  padding:15px;
}

.card {
  background:#1e293b;
  padding:15px;
  border-radius:14px;
  margin-bottom:12px;
}

.row { display:flex; gap:12px; flex-wrap:wrap; }

.metric { flex:1; min-width:140px; }

.label { font-size:12px; opacity:0.7; }
.value { font-size:22px; font-weight:bold; }

.badge {
  padding:6px 12px;
  border-radius:10px;
  font-weight:bold;
  display:inline-block;
}

.ok { background:#16a34a; }
.stale { background:#dc2626; }

button {
  padding:10px;
  border:none;
  border-radius:10px;
  margin:4px;
  cursor:pointer;
  font-weight:bold;
}

.green { background:#16a34a; color:white }
.blue { background:#2563eb; color:white }
.orange { background:#f97316; color:white }
</style>
</head>

<body>

<h1>ðŸ“ˆ WorldMarketReviewer</h1>

<div class="card row">
  <div class="metric">
    <div class="label">Active Profile</div>
    <div class="value" id="profile">Loading...</div>
  </div>

  <div class="metric">
    <div class="label">System Health</div>
    <div id="health" class="badge">Loading...</div>
  </div>

  <div class="metric">
    <div class="label">Last Update</div>
    <div class="value" id="lastUpdate">--</div>
  </div>
</div>

<div class="card">
  <button class="green" onclick="setProfile('conservative')">Conservative</button>
  <button class="blue" onclick="setProfile('balanced')">Balanced</button>
  <button class="orange" onclick="setProfile('aggressive')">Aggressive</button>
</div>

<div class="card">
  <canvas id="chart"></canvas>
</div>

<script>
let chartInstance = null;

async function loadAll() {
  try {
    const summary = await fetch("/api/summary").then(r => r.json());
    const config = await fetch("/api/config").then(r => r.json());
    const hist = await fetch("/api/history").then(r => r.json());

    document.getElementById("profile").innerText = config.active_profile;

    const labels = hist.map(h => h.timestamp.slice(0,19).replace("T", " "));
    const exp = hist.map(h => h.exposure);

    if (chartInstance) {
      chartInstance.destroy();
    }

    chartInstance = new Chart(document.getElementById("chart"), {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Exposure",
          data: exp,
          tension: 0.3
        }]
      }
    });

    // Health check
    const health = await fetch("/api/health").then(r => r.json());

    const healthEl = document.getElementById("health");
    healthEl.innerText = health.status;
    healthEl.className = "badge " + (health.status === "OK" ? "ok" : "stale");

    document.getElementById("lastUpdate").innerText =
      health.last_update
        ? health.last_update.replace("T", " ").slice(0,19)
        : "--";

  } catch (err) {
    console.error("Dashboard error:", err);
  }
}

async function setProfile(profile) {
  await fetch(`/api/profile/${profile}`, { method: "POST" });
  loadAll();
}

loadAll();
setInterval(loadAll, 30000); // auto refresh every 30s
</script>

</body>
</html>
