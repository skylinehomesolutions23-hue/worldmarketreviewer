<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WorldMarketReviewer</title>
  <style>
    :root {
      --bg: #0B1220;
      --card: #111A2E;
      --border: #223256;
      --muted: #A7B0C0;
      --text: #FFFFFF;
      --chipbg: #0B1220;
      --blue: #2E6BFF;
      --upbg: #0F2A22;
      --upbd: #1ED9A6;
      --downbg: #2A1416;
      --downbd: #FF6B6B;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; padding: 16px; background: var(--bg); color: var(--text); }
    h1 { font-size: 20px; margin: 0 0 6px 0; }
    .muted { color: var(--muted); }
    .card { border: 1px solid var(--border); background: var(--card); border-radius: 14px; padding: 12px; margin: 12px 0; }
    input { width: 100%; padding: 12px; font-size: 16px; border: 1px solid var(--border); border-radius: 10px; background: var(--chipbg); color: var(--text); }
    button { width: 100%; padding: 12px; font-size: 16px; border: 0; border-radius: 10px; background: var(--blue); color: white; font-weight: 700; }
    .row { display: flex; justify-content: space-between; gap: 8px; flex-wrap: wrap; align-items: center; }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; font-size: 12px; background: var(--chipbg); border: 1px solid var(--border); color: var(--text); font-weight: 700; }
    .chipwrap { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { cursor: pointer; user-select: none; }
    .small { font-size: 12px; }
    .item { padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .item:last-child { border-bottom: 0; }
    .badge { display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--border); font-size:12px; font-weight:800; }
    .badge.up { background: var(--upbg); border-color: var(--upbd); }
    .badge.down { background: var(--downbg); border-color: var(--downbd); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .split { display:flex; gap:10px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 240px; }
    details { margin-top: 10px; }
    pre { white-space: pre-wrap; word-break: break-word; background: #0B1220; border:1px solid var(--border); border-radius: 10px; padding: 10px; color: #E5E7EB; }
  </style>
</head>
<body>
  <h1>WorldMarketReviewer</h1>
  <div class="muted">Web app (Add to Home Screen). Backend: Render + Supabase.</div>

  <div class="card">
    <div class="muted" style="margin-bottom:8px;">Tickers (comma-separated)</div>
    <input id="tickers" value="AMZN,META,TSLA,NVDA,NFLX,AMD,INTC,JPM,BAC,GS,MS,XOM,CVX,SPY,QQQ" />

    <div style="height:10px;"></div>

    <div class="row">
      <span class="pill" id="horizonPill">Horizon: 5d</span>
      <span class="pill" id="retrainPill">Retrain: ON</span>
      <span class="pill" id="filterPill">Filter: ALL</span>
      <span class="pill" id="sortPill">Sort: Prob ↓</span>
    </div>

    <div style="height:10px;"></div>
    <button id="runBtn">Run Predictions</button>
    <div id="status" class="muted" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <div class="row">
      <div><b>Results</b></div>
      <div id="runPill" class="pill" style="display:none;"></div>
    </div>

    <div id="meta" class="muted small" style="margin-top:6px;"></div>

    <div class="split" style="margin-top:10px;">
      <div class="col">
        <b>Top UP</b>
        <div id="topUp" class="muted" style="margin-top:8px;">—</div>
      </div>
      <div class="col">
        <b>Top DOWN</b>
        <div id="topDown" class="muted" style="margin-top:8px;">—</div>
      </div>
    </div>

    <div style="height:10px;"></div>
    <b>All results</b>
    <div id="results" class="muted" style="margin-top:10px;">No results yet.</div>

    <details>
      <summary class="muted">Debug JSON</summary>
      <pre id="debug" class="mono"></pre>
    </details>
  </div>

<script>
  const API = ""; // same origin

  const elTickers = document.getElementById("tickers");
  const elRunBtn = document.getElementById("runBtn");
  const elStatus = document.getElementById("status");
  const elResults = document.getElementById("results");
  const elTopUp = document.getElementById("topUp");
  const elTopDown = document.getElementById("topDown");
  const elRunPill = document.getElementById("runPill");
  const elMeta = document.getElementById("meta");
  const elDebug = document.getElementById("debug");

  const elHorizonPill = document.getElementById("horizonPill");
  const elRetrainPill = document.getElementById("retrainPill");
  const elFilterPill = document.getElementById("filterPill");
  const elSortPill = document.getElementById("sortPill");

  let horizonDays = 5;
  let retrain = true;
  let filter = "ALL"; // ALL / UP / DOWN
  let sort = "PROB_DESC"; // PROB_DESC / EXP_DESC / TICKER_ASC

  function fmtPct(x) {
    const n = typeof x === "number" ? x : Number(x);
    if (!Number.isFinite(n)) return "-";
    return (n * 100).toFixed(1) + "%";
  }
  function fmtNum(x, digits=4) {
    const n = typeof x === "number" ? x : Number(x);
    if (!Number.isFinite(n)) return "-";
    return n.toFixed(digits);
  }

  function setStatus(text) {
    elStatus.textContent = text || "";
  }

  function badge(dir) {
    const d = String(dir || "").toUpperCase();
    const cls = d === "UP" ? "up" : "down";
    return `<span class="badge ${cls}">${d || "?"}</span>`;
  }

  function card(p) {
    return `
      <div class="item">
        <div class="row">
          <div><b>${p.ticker}</b> ${badge(p.direction)}</div>
          <div><b>${fmtPct(p.prob_up)}</b></div>
        </div>
        <div class="muted small">exp: ${fmtNum(p.exp_return,4)} • horizon: ${p.horizon_days ?? "-"}d ${p.source ? "• src: " + p.source : ""}</div>
      </div>
    `;
  }

  function renderList(el, preds) {
    if (!preds || preds.length === 0) {
      el.innerHTML = `<div class="muted">None.</div>`;
      return;
    }
    el.innerHTML = preds.map(card).join("");
  }

  function sortPreds(arr) {
    const a = [...arr];
    if (sort === "TICKER_ASC") a.sort((x,y)=>String(x.ticker).localeCompare(String(y.ticker)));
    else if (sort === "EXP_DESC") a.sort((x,y)=>(Number(y.exp_return)||-999)-(Number(x.exp_return)||-999));
    else a.sort((x,y)=>(Number(y.prob_up)||-999)-(Number(x.prob_up)||-999));
    return a;
  }

  function applyFilter(arr) {
    if (filter === "ALL") return arr;
    return arr.filter(p => String(p.direction||"").toUpperCase() === filter);
  }

  function computeTop(preds) {
    const ups = preds.filter(p => String(p.direction||"").toUpperCase() === "UP")
      .sort((a,b)=>(Number(b.prob_up)||-999)-(Number(a.prob_up)||-999))
      .slice(0,5);
    const downs = preds.filter(p => String(p.direction||"").toUpperCase() === "DOWN")
      .sort((a,b)=>(Number(a.prob_up)||999)-(Number(b.prob_up)||999))
      .slice(0,5);
    return { ups, downs };
  }

  function updatePills() {
    elHorizonPill.textContent = `Horizon: ${horizonDays}d`;
    elRetrainPill.textContent = `Retrain: ${retrain ? "ON" : "OFF"}`;
    elFilterPill.textContent = `Filter: ${filter}`;
    elSortPill.textContent = `Sort: ${sort === "PROB_DESC" ? "Prob ↓" : sort === "EXP_DESC" ? "Exp ↓" : "Ticker A–Z"}`;
  }

  elHorizonPill.addEventListener("click", () => {
    horizonDays = horizonDays === 5 ? 10 : horizonDays === 10 ? 20 : 5;
    updatePills();
  });
  elRetrainPill.addEventListener("click", () => {
    retrain = !retrain;
    updatePills();
  });
  elFilterPill.addEventListener("click", () => {
    filter = filter === "ALL" ? "UP" : filter === "UP" ? "DOWN" : "ALL";
    updatePills();
  });
  elSortPill.addEventListener("click", () => {
    sort = sort === "PROB_DESC" ? "EXP_DESC" : sort === "EXP_DESC" ? "TICKER_ASC" : "PROB_DESC";
    updatePills();
  });

  updatePills();

  async function startRun(tickers) {
    const res = await fetch(`${API}/api/run_phase2`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        tickers,
        horizon_days: horizonDays,
        retrain: retrain,
        max_parallel: 1
      })
    });
    return res.json();
  }

  async function getStatus(runId) {
    const res = await fetch(`${API}/api/run_phase2/status?run_id=${encodeURIComponent(runId)}`);
    return res.json();
  }

  async function getSummary(runId) {
    const res = await fetch(`${API}/api/summary?run_id=${encodeURIComponent(runId)}&limit=200`);
    return res.json();
  }

  function clearResults() {
    elResults.textContent = "No results.";
    elTopUp.textContent = "—";
    elTopDown.textContent = "—";
    elMeta.textContent = "";
    elDebug.textContent = "";
  }

  elRunBtn.addEventListener("click", async () => {
    const tickers = elTickers.value.split(",").map(s => s.trim()).filter(Boolean);
    if (tickers.length === 0) return;

    elRunBtn.disabled = true;
    setStatus("Starting run...");
    clearResults();

    const started = await startRun(tickers);
    const runId = started.run_id;

    elRunPill.style.display = "inline-block";
    elRunPill.textContent = runId;

    setStatus(`Running... 0/${started.total ?? tickers.length}`);

    const poll = setInterval(async () => {
      const s = await getStatus(runId);
      if (s.error) {
        setStatus("Error: " + s.error);
        clearInterval(poll);
        elRunBtn.disabled = false;
        return;
      }
      setStatus(`Status: ${s.status} — ${s.progress.completed}/${s.progress.total}`);

      if (s.status === "finished") {
        clearInterval(poll);
        const out = await getSummary(runId);
        const preds = Array.isArray(out.predictions) ? out.predictions : [];

        elMeta.textContent = `generated_at: ${out.generated_at || ""}  •  run_id: ${out.run_id || ""}`;

        // top sections
        const { ups, downs } = computeTop(preds);
        renderList(elTopUp, ups);
        renderList(elTopDown, downs);

        // main list with filter/sort
        const filtered = applyFilter(preds);
        const sorted = sortPreds(filtered);
        if (sorted.length === 0) elResults.textContent = "No predictions returned.";
        else elResults.innerHTML = sorted.map(card).join("");

        elDebug.textContent = JSON.stringify(out, null, 2);
        setStatus("Finished.");
        elRunBtn.disabled = false;
      }
    }, 1500);
  });
</script>
</body>
</html>
